<!DOCTYPE html>
<html lang="de">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Billettautomat</title>
    <style>
      body {
        font-family: sans-serif;
        margin: 0;
        padding: 1em;
        background-color: #fff;
      }
    </style>
  </head>
  <body>
    <h1>Billettautomat</h1>
    <billettautomat-app> </billettautomat-app>

    <script type="module">
      // @ts-check

      /**
       * @typedef Item
       * @property {string} origin
       * @property {string} destination
       * @property {string} color
       * @property {string} price
       * @property {string} date
       * @property {string} class
       * @property {string} direction
       * @property {string} type
       * @property {string} validity
       * @property {number} number1
       * @property {number} number2
       * @property {number} number3
       */

      /**
       * Syntax highlighting for tagged template literals
       * https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String/raw#building_an_identity_tag
       * Combined with https://marketplace.visualstudio.com/items?itemName=Tobermory.es6-string-html, e.g.
       */
      const html = (strings, ...values) =>
        String.raw({ raw: strings }, ...values);
      const css = html;

      /**
       * Visually hidden elements
       */
      class VisuallyHidden extends HTMLElement {
        connectedCallback() {
          this.style.position = "absolute";
          this.style.width = "1px";
          this.style.height = "1px";
          this.style.padding = "0";
          this.style.border = "0";
          this.style.overflow = "hidden";
          this.style.clip = "rect(0 0 0 0)";
          this.style.clipPath = "inset(50%)";
          this.style.whiteSpace = "nowrap";
        }
      }
      customElements.define("visually-hidden", VisuallyHidden);

      /**
       * Single ticket
       */
      class Ticket extends HTMLElement {
        static observedAttributes = [
          "date",
          "type",
          "validity",
          "origin",
          "destination",
          "direction",
          "class",
          "price",
          "number1",
          "number2",
          "number3",
          "color",
        ];

        connectedCallback() {
          this.shadow = this.attachShadow({ mode: "open" });

          // Content container
          this.content = document.createElement("div");
          this.content.classList.add("content");
          this.shadow.appendChild(this.content);

          // Styles
          const style = document.createElement("style");
          style.textContent = css`
            :host {
              --color: ${this.getAttribute("color") || "#FFC62A"};

              display: flex;
              flex-direction: column;
              background: linear-gradient(
                to bottom,
                #fff,
                #fff 50%,
                var(--color) 50%,
                var(--color)
              );
              font-family: sans-serif;
              padding: 0.5em 0.5em;
            }
            .content {
              flex: 1;
              display: flex;
              flex-direction: column;
            }
            dt {
              clip: rect(0 0 0 0);
              clip-path: inset(50%);
              height: 1px;
              overflow: hidden;
              position: absolute;
              white-space: nowrap;
              width: 1px;
            }
            dl {
              flex: 1;
              margin: 0;
              display: grid;
              grid-template-rows: 1fr 1fr;

              > * {
                display: grid;
                grid-template-columns: 1fr 1fr;
              }
            }
            dd {
              margin: 0;
              text-align: center;
              font-weight: bold;
              grid-column: 1 / -1;
            }

            .date {
              margin-block-end: 0.25em;
            }
            .type {
              font-weight: normal;
              font-size: 0.75em;
            }
            .validity {
              font-weight: normal;
              font-size: 0.75em;
              margin-block-end: 0.75em;
            }
            .origin {
              margin-block-end: 1em;
            }
            .destination {
              font-size: 1.25em;
              margin-block-end: 0.5em;
            }
            .direction {
              margin-block-start: 0.5em;
              margin-block-end: 1em;
              margin-inline: 1em;
              background: #000;
              display: flex;
              flex-direction: column;
              gap: 0.25em;
              padding: 0.45em 1em;

              &::before {
                content: "⟶";
                color: #fff;
                line-height: 0.1;
              }

              &.destination--return {
                padding: 0.25em 1em;

                &::after {
                  content: "⟵";
                  color: #fff;
                  line-height: 0.1;
                }
              }
            }
            .class {
              text-align: start;
              grid-column: 1 / 2;
            }
            .price {
              text-align: end;
              grid-column: 2 / -1;
              font-family: serif;
              margin-block-end: 0.5em;

              small {
                display: block;
                font-size: 0.8em;
                letter-spacing: 0.1em;
              }
            }
            .number1 {
              text-align: start;
              grid-column: 1 / 2;
              font-size: 0.75em;
            }
            .number2 {
              text-align: end;
              grid-column: 2 / -1;
              font-size: 0.75em;
            }
            .number3 {
              margin-block-start: 0.5em;
              margin-block-end: -0.25em;
              font-size: 1.5em;
              letter-spacing: 0.2em;
            }
          `;
          this.shadow.appendChild(style);

          this.render();
        }

        render() {
          if (!this.content) {
            return;
          }

          this.content.innerHTML = html`
            <dl>
              <div class="group">
                <dt>Datum</dt>
                <dd class="date">${this.getAttribute("date")}</dd>
                <dt>Typ</dt>
                <dd class="type">${this.getAttribute("type")}</dd>
                <dt>Gültigkeit</dt>
                <dd class="validity">
                  Gültig ${this.getAttribute("validity")}
                </dd>
                <dt>Abfahrtsort</dt>
                <dd class="origin">${this.getAttribute("origin")}</dd>
                <dt>Zielort</dt>
                <dd class="destination">${this.getAttribute("destination")}</dd>
              </div>
              <div class="group">
                <dt>Richtung</dt>
                <dd
                  class="direction destination--${this.getAttribute(
                    "direction"
                  ) === "Retourfahrt"
                    ? "return"
                    : "oneway"}"
                >
                  <visually-hidden
                    >${this.getAttribute("direction")}</visually-hidden
                  >
                </dd>
                <dt>Klasse</dt>
                <dd class="class">${this.getAttribute("class")}</dd>
                <dt>Preis</dt>
                <dd class="price">
                  ${this.getAttribute("price")}
                  <small>${this.getAttribute("price")}</small>
                </dd>
                <dt>Nummer 1</dt>
                <dd class="number1">${this.getAttribute("number1")}</dd>
                <dt>Nummer 2</dt>
                <dd class="number2">${this.getAttribute("number2")}</dd>
                <dt>Nummer 3</dt>
                <dd class="number3">${this.getAttribute("number3")}</dd>
              </div>
            </dl>
          `;
        }

        attributeChangedCallback() {
          this.render();
        }
      }
      customElements.define("billettautomat-ticket", Ticket);

      /**
       * Ticketing app
       */
      class App extends HTMLElement {
        /** @type {Item[]} */
        #items = [];
        /** @type {HTMLFormElement} */
        form;
        /** @type {HTMLFormElement} */
        items;

        connectedCallback() {
          this.#items = JSON.parse(
            localStorage.getItem("billett-automat") || "[]"
          );

          this.shadow = this.attachShadow({ mode: "open" });

          this.shadow.innerHTML = html`
            <div class="content">
              <form class="form">
                <input type="hidden" name="index" />
                <div class="fields">
                  <div>
                    <label for="origin">Abfahrtsort</label>
                    <input type="text" name="origin" id="origin" required />
                  </div>
                  <div>
                    <label for="destination">Zielort</label>
                    <input
                      type="text"
                      name="destination"
                      id="destination"
                      required
                    />
                  </div>
                  <div>
                    <label for="color">Farbe</label>
                    <input
                      type="color"
                      name="color"
                      id="color"
                      required
                      value="${this.#items[0]?.color || "#FFC62A"}"
                    />
                  </div>
                  <div>
                    <label for="price">Preis</label>
                    <input type="number" name="price" id="price" required />
                  </div>
                </div>
                <details>
                  <summary>Erweiterte Optionen</summary>
                  <div class="fields">
                    <div>
                      <label for="date">Datum</label>
                      <input type="date" name="date" id="date" />
                    </div>
                    <fieldset>
                      <legend>Klasse</legend>
                      <div>
                        <div>
                          <input
                            type="radio"
                            name="class"
                            id="class2"
                            value="2. Kl"
                            checked
                          />
                          <label for="class2">2. Klasse</label>
                        </div>
                        <div>
                          <input
                            type="radio"
                            name="class"
                            id="class1"
                            value="1. Kl"
                          />
                          <label for="class1">1. Klasse</label>
                        </div>
                      </div>
                    </fieldset>
                    <fieldset>
                      <legend>Richtung</legend>
                      <div>
                        <div>
                          <input
                            type="radio"
                            name="direction"
                            id="direction1"
                            value="Einfache Fahrt"
                          />
                          <label for="direction1">Einfache Fahrt</label>
                        </div>
                        <div>
                          <input
                            type="radio"
                            name="direction"
                            id="direction2"
                            value="Retourfahrt"
                            checked
                          />
                          <label for="direction2">Retourfahrt</label>
                        </div>
                      </div>
                    </fieldset>
                    <fieldset>
                      <legend>Typ</legend>
                      <div>
                        <div>
                          <input
                            type="radio"
                            name="type"
                            id="type1"
                            value="1/2 Preis"
                            checked
                          />
                          <label for="type1">1/2 Preis</label>
                        </div>
                        <div>
                          <input
                            type="radio"
                            name="type"
                            id="type2"
                            value="1/1 Preis"
                          />
                          <label for="type2">1/1 Preis</label>
                        </div>
                      </div>
                    </fieldset>
                    <div>
                      <label for="validity">Gültigkeit</label>
                      <input type="text" name="validity" id="validity" />
                    </div>
                    <div>
                      <label for="number1">Nummer 1</label>
                      <input type="number" name="number1" id="number1" />
                    </div>
                    <div>
                      <label for="number2">Nummer 2</label>
                      <input type="number" name="number2" id="number2" />
                    </div>
                    <div>
                      <label for="number3">Nummer 3</label>
                      <input type="number" name="number3" id="number3" />
                    </div>
                  </div>
                </details>
                <button type="submit">Erstellen</button>
              </form>
              <ul class="items"></ul>
              <div class="actions actions--global">
                <button type="button" data-copy>Daten kopieren</button>
                <button type="button" data-paste>Daten einfügen</button>
              </div>
            </div>
          `;

          // Styles
          const style = document.createElement("style");
          style.textContent = css`
            :host {
              display: block;
              container-type: inline-size;

              @container (width > 50em) {
                .content {
                  align-items: start;
                  grid-template-columns: auto 20em;
                }
                .items {
                  order: -1;
                }
                .form {
                  position: sticky;
                  top: 1em;
                  align-self: start;
                }
              }
            }
            .content {
              display: grid;
              gap: 3em;
            }
            .form {
              scroll-margin-block-start: 1em;

              .fields {
                display: grid;
                grid-template-columns: 7em auto;
                grid-gap: 0.5em 1em;

                > div,
                > fieldset {
                  display: contents;
                }
              }

              details {
                margin-block: 1em;

                .fields {
                  margin-block-start: 1em;
                }
              }
            }
            .items {
              display: grid;
              grid-template-columns: repeat(auto-fill, minmax(10em, 1fr));
              grid-gap: 2em 1em;
              list-style: none;
              padding: 0;
              margin: 0;

              li {
                position: relative;
                display: flex;
                flex-direction: column;
                gap: 0.5em;
              }

              billettautomat-ticket {
                box-shadow: 0 0 0.5em rgba(0, 0, 0, 0.2);
                flex: 1;
              }
            }
            .actions {
              display: flex;
              justify-content: end;
              gap: 0.5em;

              &.actions--global {
                grid-column: 1 / -1;
              }
            }

            @media print {
              :host {
                print-color-adjust: exact;
              }
              .form,
              .actions {
                display: none;
              }
              .items {
                grid-template-columns: repeat(4, 1fr);
              }
            }
          `;
          this.shadow.appendChild(style);

          // @ts-expect-error
          this.items = this.shadow.querySelector(".items");
          // @ts-expect-error
          this.form = this.shadow.querySelector(".form");
          this.form.addEventListener("submit", (event) => {
            event.preventDefault();

            const formData = new FormData(this.form);
            const { index, ...data } = Object.fromEntries(formData.entries());
            /** @type {Item} */
            const item = {
              origin: data.origin?.toString() || "",
              destination: data.destination?.toString() || "",
              color: data.color?.toString() || "",
              price: (data.price ? Number(data.price) : 1)
                .toFixed(2)
                .padStart(6, "0"),
              date:
                data.date?.toString() || new Date().toISOString().split("T")[0],
              class: data.class?.toString() || "",
              direction: data.direction?.toString() || "",
              type: data.type?.toString() || "",
              validity: data.validity?.toString() || "1 Monat",
              number1: data.number1
                ? Number(data.number1)
                : Math.floor(Math.random() * 1000000),
              number2: data.number2
                ? Number(data.number2)
                : Math.floor(Math.random() * 10000),
              number3: data.number3
                ? Number(data.number3)
                : Math.floor(Math.random() * 10000),
            };

            if (index) {
              this.#items[Number(index.toString())] = item;
            } else {
              this.#items.unshift(item);
            }

            this.update();

            this.form.reset();
            /** @type {HTMLInputElement} */ (
              this.form.querySelector("[name='index']")
            ).value = "";
          });

          this.shadow.addEventListener("click", this);

          this.render();
        }

        async handleEvent(event) {
          if (event.target.matches("[data-copy]")) {
            const data = JSON.stringify(this.#items, null, 2);

            await navigator.clipboard.writeText(data);

            alert("Daten kopiert!");
          } else if (event.target.matches("[data-paste]")) {
            try {
              const data = await navigator.clipboard.readText();
              const items = JSON.parse(data);

              if (Array.isArray(items)) {
                this.#items = [...items, ...this.#items];
              }

              this.update();
            } catch (err) {
              console.error(err);
            }
          }
        }

        update() {
          localStorage.setItem("billett-automat", JSON.stringify(this.#items));

          this.render();
        }

        render() {
          if (!this.items) {
            return;
          }

          this.items.innerHTML = "";

          this.#items.forEach((item, index) => {
            const wrapper = document.createElement("li");

            const actions = document.createElement("div");

            actions.classList.add("actions");

            wrapper.appendChild(actions);

            const billet = document.createElement("billettautomat-ticket");

            for (const [key, value] of Object.entries(item)) {
              billet.setAttribute(key, String(value));
            }

            wrapper.appendChild(billet);

            const editButton = document.createElement("button");

            editButton.innerHTML = html`<span role="presentation">✎</span
              ><visually-hidden>Bearbeiten</visually-hidden>`;
            editButton.addEventListener("click", () => this.editItem(index));

            actions.appendChild(editButton);

            const removeButton = document.createElement("button");

            removeButton.innerHTML = html`<span role="presentation">✕</span
              ><visually-hidden>Entfernen</visually-hidden>`;
            removeButton.addEventListener("click", () =>
              this.removeItem(index)
            );

            actions.appendChild(removeButton);

            this.items.appendChild(wrapper);
          });
        }

        removeItem(index) {
          this.#items.splice(index, 1);

          this.update();
        }

        editItem(index) {
          this.form.scrollIntoView({
            behavior: "smooth",
          });
          /** @type {HTMLInputElement} */ (
            this.form.querySelector("[name='origin']")
          ).focus();

          const item = this.#items[index];

          for (const [key, value] of Object.entries({ ...item, index })) {
            /** @type {HTMLInputElement | null} */
            const input = this.form.querySelector(`[name="${key}"]`);

            if (input) {
              if (input.type === "radio") {
                input.checked = input.value === value;
              } else {
                input.value = value;
              }
            }
          }
        }
      }
      customElements.define("billettautomat-app", App);
    </script>
  </body>
</html>
